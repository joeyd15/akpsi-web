<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Credit Event History | AKPsi Portal</title>

  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body { font-family: 'Raleway', sans-serif; background: #f8f9fa; }
    .history-card {
      margin-top: 100px;
      padding: 2rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    th { cursor: pointer; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
  <div class="container">
    <a class="navbar-brand fw-bold" href="index.html">AKPsi Portal</a>
  </div>
</nav>

<main class="container">
  <div class="history-card">
    <h3 class="fw-bold mb-4 text-center">Credit Event History</h3>

    <div class="table-responsive">
      <table class="table table-bordered text-center align-middle">
        <thead class="table-dark">
          <tr>
            <th onclick="sortTable('name')">Event Name</th>
            <th onclick="sortTable('category')">Category</th>
            <th onclick="sortTable('creditValue')">Credits</th>
            <th onclick="sortTable('active')">Status</th>
            <th onclick="sortTable('createdAt')">Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="eventsTable"></tbody>
      </table>
    </div>
  </div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    getDocs,
    deleteDoc,
    doc,
    query,
    where
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAQGY6rTnONnmBUUnrWpHM5qvyMz9BpfN8",
    authDomain: "akpsi-web.firebaseapp.com",
    projectId: "akpsi-web",
    storageBucket: "akpsi-web.appspot.com",
    messagingSenderId: "268414380859",
    appId: "1:268414380859:web:52cdd93b22d7801f60251e"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const tableBody = document.getElementById("eventsTable");

  let allEvents = [];
  let sortField = null;
  let sortAsc = true;

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "signin.html";
      return;
    }
    loadEvents();
  });

  async function loadEvents() {
    allEvents = [];
    tableBody.innerHTML = "";

    const snap = await getDocs(collection(db, "creditEvents"));
    snap.forEach(d => {
      allEvents.push({ id: d.id, ...d.data() });
    });

    renderTable();
  }

  function renderTable() {
    tableBody.innerHTML = "";

    let events = [...allEvents];

    if (sortField) {
      events.sort((a, b) => {
        let x = a[sortField];
        let y = b[sortField];

        if (x?.toDate) x = x.toDate();
        if (y?.toDate) y = y.toDate();

        if (x === undefined) return 1;
        if (y === undefined) return -1;

        return (x > y ? 1 : -1) * (sortAsc ? 1 : -1);
      });
    }

    events.forEach(e => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${e.name}</td>
        <td>${e.category.replace(/([A-Z])/g, " $1")}</td>
        <td>${e.creditValue}</td>
        <td>
          <span class="badge ${e.active ? "bg-success" : "bg-secondary"}">
            ${e.active ? "Active" : "Closed"}
          </span>
        </td>
        <td>${e.createdAt?.toDate?.().toLocaleString() || ""}</td>
        <td>
          <button class="btn btn-sm btn-danger"
            onclick="deleteEvent('${e.id}', '${e.name.replace(/'/g, "\\'")}')">
            Delete
          </button>
        </td>
      `;
      tableBody.appendChild(row);
    });
  }

  window.sortTable = function(field) {
    if (sortField === field) sortAsc = !sortAsc;
    else {
      sortField = field;
      sortAsc = true;
    }
    renderTable();
  };

  window.deleteEvent = async function(eventId, eventName) {
    const ok = confirm(
      `Delete "${eventName}"?\n\nCredits already earned will NOT be removed.`
    );
    if (!ok) return;

    await deleteDoc(doc(db, "creditEvents", eventId));

    const attendanceSnap = await getDocs(
      query(collection(db, "creditAttendance"), where("eventId", "==", eventId))
    );

    for (const a of attendanceSnap.docs) {
      await deleteDoc(doc(db, "creditAttendance", a.id));
    }

    alert("Event deleted.");
    loadEvents();
  };
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
