<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mentions | AKPsi Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body { font-family: 'Raleway', sans-serif; background: #f8f9fa; }
    .card { border-radius: 15px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">AKPsi Portal</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="members.html">Members</a></li>
          <li class="nav-item"><a class="nav-link" href="brother-portal.html">Brother Portal</a></li>
          <li class="nav-item"><a class="nav-link active" href="#">Mentions</a></li>
          <li class="nav-item"><a class="nav-link" href="rush-dashboard.html">Rush Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" id="greeting">Hi!</a></li>
          <li class="nav-item"><button id="authButton" class="btn btn-outline-light btn-sm ms-2">Sign In</button></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container" style="margin-top:100px;">
    <div class="card p-4">
      <h3 class="fw-bold mb-3 text-center">Submit a Mention or Interview Feedback</h3>
      <p class="text-muted text-center">Your name is stored for credit tracking.</p>
      
      <!-- Dropdown PNM selection -->
      <div class="mb-3">
        <label for="pnmSelect" class="form-label">Select PNM</label>
        <select id="pnmSelect" class="form-select">
          <option value="">Loading PNMs...</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label fw-bold">Entry Type</label><br />
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="mode" id="modeMention" value="mention" checked />
          <label class="form-check-label" for="modeMention">Mention</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="mode" id="modeInterview" value="interview" />
          <label class="form-check-label" for="modeInterview">Interview</label>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Type of Mention</label>
        <select id="mentionType" class="form-select">
          <option value="positive">Positive</option>
          <option value="negative">Negative</option>
        </select>
        <div class="form-text">For interviews, you can leave this as positive.</div>
      </div>

      <div id="interviewScores" class="mb-3 d-none">
        <label class="form-label fw-bold">Interview Scores (1–5)</label>
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Friendliness</label>
            <select id="friendliness" class="form-select">
              <option value="">Select</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Energy</label>
            <select id="energy" class="form-select">
              <option value="">Select</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Interest</label>
            <select id="interest" class="form-select">
              <option value="">Select</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Comment / Feedback</label>
        <textarea id="comment" class="form-control" rows="3" placeholder="Write your comment here..."></textarea>
      </div>

      <button id="submitBtn" class="btn btn-primary w-100">
        <i class="bi bi-send"></i> Submit
      </button>

      <div id="status" class="mt-3 text-center text-muted"></div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./jsauth.js";
    import { collection, getDocs, addDoc, doc, updateDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

    const greeting = document.getElementById("greeting");
    const authButton = document.getElementById("authButton");
    const pnmSelect = document.getElementById("pnmSelect");
    const mentionType = document.getElementById("mentionType");
    const comment = document.getElementById("comment");
    const submitBtn = document.getElementById("submitBtn");
    const statusDiv = document.getElementById("status");
    const interviewScores = document.getElementById("interviewScores");
    const friendliness = document.getElementById("friendliness");
    const energy = document.getElementById("energy");
    const interest = document.getElementById("interest");

    async function loadPNMs() {
      pnmSelect.innerHTML = '<option>Loading PNMs...</option>';
      try {
        const snapshot = await getDocs(collection(db, "users"));
        pnmSelect.innerHTML = "";
        let foundAny = false;
        snapshot.forEach((docSnap) => {
          const u = docSnap.data();
          if (u.role === "pnm") {
            foundAny = true;
            const opt = document.createElement("option");
            opt.value = docSnap.id;
            opt.textContent = `${u.firstName || ""} ${u.lastName || ""}`;
            pnmSelect.appendChild(opt);
          }
        });
        if (!foundAny) {
          const opt = document.createElement("option");
          opt.textContent = "No PNMs found.";
          opt.disabled = true;
          pnmSelect.appendChild(opt);
        }
      } catch (err) {
        const opt = document.createElement("option");
        opt.textContent = "Error loading PNMs.";
        opt.disabled = true;
        pnmSelect.appendChild(opt);
        console.error("Error loading PNMs:", err);
      }
    }

    onAuthStateChanged(auth, (user) => {
      if (user) loadPNMs();
    });

    document.querySelectorAll('input[name="mode"]').forEach(r => {
      r.addEventListener("change", () => {
        interviewScores.classList.toggle("d-none", !document.getElementById("modeInterview").checked);
      });
    });

    submitBtn.addEventListener("click", async () => {
      const pnmId = pnmSelect.value;
      const type = mentionType.value;
      const text = comment.value.trim();
      const mode = document.querySelector('input[name="mode"]:checked').value;
      const user = auth.currentUser;

      if (!pnmId || pnmId === "") {
    statusDiv.textContent = "❌ Please select a PNM before submitting.";
    return;
  }
  if (!text || text.length === 0) {
    statusDiv.textContent = "❌ Please enter a comment before submitting.";
    return;
  }
  if (!user) {
    statusDiv.textContent = "❌ You must be signed in to submit.";
    return;
  }


      try {
        if (mode === "mention") {
          await addDoc(collection(db, "mentions"), {
            pnmId,
            type,
            comment: text,
            brotherName: user.email,
            timestamp: serverTimestamp()
          });
          const field = type === "positive" ? "positiveMentions" : "negativeMentions";
          await updateDoc(doc(db, "users", pnmId), { [field]: increment(1) });
          statusDiv.textContent = "✅ Mention recorded successfully!";
        } else {
          await addDoc(collection(db, "interviews"), {
            pnmId,
            interviewerId: user.uid,
            interviewerName: user.email,
            friendliness: parseInt(friendliness.value) || 0,
            energy: parseInt(energy.value) || 0,
            interest: parseInt(interest.value) || 0,
            comments: text,
            timestamp: new Date()
          });
          statusDiv.textContent = "✅ Interview submitted successfully!";
        }
        comment.value = "";
        friendliness.value = "";
        energy.value = "";
        interest.value = "";
      } catch (e) {
        statusDiv.textContent = "❌ Error submitting. Check console for details.";
        console.error("Error submitting mention/interview:", e);
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
