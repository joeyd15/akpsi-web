<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Upload PNM Photo | AKPsi Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body { font-family: "Raleway", sans-serif; background: #f8f9fa; }
    .card { border-radius: 15px; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1); }
    #preview { display: none; margin-top: 10px; max-width: 200px; border-radius: 8px; }
    #pnmList { max-height: 300px; overflow-y: auto; margin-bottom: 1rem; }
    .pnm-entry { display: flex; justify-content: space-between; align-items: center; padding: 0.25rem 0; border-bottom: 1px solid #ddd; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">AKPsi Portal</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="admin-portal.html">Admin Portal</a></li>
          <li class="nav-item"><a class="nav-link active" href="#">Upload PNM Photos</a></li>
          <li class="nav-item"><span class="nav-link" id="greeting">Hi!</span></li>
          <li class="nav-item"><a class="btn btn-outline-light ms-2" href="signin.html" id="authButton">Sign In</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container" style="margin-top:100px;">
    <div class="card p-4">
      <h3 class="fw-bold text-center mb-3">Upload PNM Photo</h3>
      <p class="text-muted text-center">Select a PNM and upload their photo below.</p>

      <div id="errorMessage" class="text-danger text-center mb-2"></div>

      <div id="pnmList">
        Loading PNMs...
      </div>

      <div id="uploadForm" style="display:none;">
        <div>
          <strong>Selected PNM:</strong> <span id="selectedPNMName"></span>
        </div>

        <div class="mb-3 mt-3">
          <label class="form-label" for="photoInput">Choose Photo</label>
          <input type="file" id="photoInput" class="form-control" accept="image/*" capture="environment" />
          <img id="preview" alt="Preview" />
        </div>

        <button id="uploadBtn" class="btn btn-primary w-100">
          <i class="bi bi-upload"></i> Upload Photo
        </button>

        <div id="progress" class="mt-3 text-center text-muted"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, getPNMList, uploadPNMPhoto, savePhotoToPNM, listenAuth } from "./jsauth.js";

    // ----- DEBUG SECTION -----
    // Print out sign-in state at load and at any auth change
    console.log("Current Firebase user at load:", auth.currentUser);
    auth.onAuthStateChanged(user => {
      console.log("onAuthStateChanged (upload-photo):", user);
    });
    // ----- END DEBUG -----

    const greetingSpan = document.getElementById("greeting");
    const authButton = document.getElementById("authButton");
    const errorMessage = document.getElementById("errorMessage");
    const pnmListDiv = document.getElementById("pnmList");
    const uploadForm = document.getElementById("uploadForm");
    const selectedPNMNameSpan = document.getElementById("selectedPNMName");
    const photoInput = document.getElementById("photoInput");
    const preview = document.getElementById("preview");
    const uploadBtn = document.getElementById("uploadBtn");
    const progressDiv = document.getElementById("progress");

    let selectedPNMId = null;

    listenAuth({
      greeting: greetingSpan,
      authButton: authButton,
      brotherPortalLink: null,
      adminPortalLink: null,
      mentionsLink: null,
      pnmDashboardLink: null,
      rushDashboardLink: null,
      interviewDashboardLink: null,
    });

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        greetingSpan.textContent = "Hi!";
        authButton.textContent = "Sign In";
        authButton.href = "signin.html";
        errorMessage.textContent = "⚠️ You must be signed in to upload a PNM photo.";
        pnmListDiv.innerHTML = "";
        uploadForm.style.display = "none";
        return;
      }

      greetingSpan.textContent = user.email.split("@")[0] ? `Hi, ${user.email.split("@")[0]}!` : "Hi!";
      authButton.textContent = "Log Out";
      authButton.href = "#";
      authButton.onclick = async (e) => {
        e.preventDefault();
        await auth.signOut();
        window.location.href = "signin.html";
      };
      errorMessage.textContent = "";

      try {
        const pnms = await getPNMList();
        if (pnms.length === 0) {
          pnmListDiv.textContent = "No PNMs found";
          uploadForm.style.display = "none";
          return;
        }
        pnmListDiv.innerHTML = "";
        pnms.forEach((pnm) => {
          const entryDiv = document.createElement("div");
          entryDiv.className = "pnm-entry";
          entryDiv.innerHTML = `
            <span>${pnm.firstName || ""} ${pnm.lastName || ""}</span>
            <button class="btn btn-sm btn-outline-primary select-pnm-btn">Select</button>
          `;
          const btn = entryDiv.querySelector("button");
          btn.addEventListener("click", () => {
            selectedPNMId = pnm.id;
            selectedPNMNameSpan.textContent = `${pnm.firstName || ""} ${pnm.lastName || ""}`.trim() || pnm.email;
            uploadForm.style.display = "block";
            preview.style.display = "none";
            photoInput.value = "";
            progressDiv.textContent = "";
          });
          pnmListDiv.appendChild(entryDiv);
        });
      } catch (err) {
        console.error("Error loading PNMs:", err);
        pnmListDiv.textContent = "Error loading PNMs";
        uploadForm.style.display = "none";
      }
    });

    photoInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      preview.src = URL.createObjectURL(file);
      preview.style.display = "block";
    });

    uploadBtn.addEventListener("click", async () => {
      const file = photoInput.files[0];
      if (!selectedPNMId) {
        progressDiv.textContent = "❌ Please select a PNM.";
        return;
      }
      if (!file) {
        progressDiv.textContent = "❌ Please choose a photo.";
        return;
      }

      try {
        progressDiv.textContent = "Uploading...";
        const url = await uploadPNMPhoto(selectedPNMId, file, (pct) => {
          progressDiv.textContent = `Uploading... ${Math.round(pct)}%`;
        });
        await savePhotoToPNM(selectedPNMId, url);
        progressDiv.textContent = "✅ Upload complete!";
        preview.src = url;
      } catch (err) {
        console.error("Upload failed:", err);
        progressDiv.textContent = "❌ Upload failed. Check console.";
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
