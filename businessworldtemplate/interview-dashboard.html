<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interview Dashboard | AKPsi Portal</title>

  <!-- Fonts & Bootstrap -->
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    body {
      font-family: 'Raleway', sans-serif;
      background: #f8f9fa;
    }
    .dashboard-card {
      margin-top: 100px;
      padding: 2rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    th {
      background: #003366;
      color: #FFD700;
      cursor: pointer;
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm fixed-top">
  <div class="container">
    <a class="navbar-brand fw-bold" href="index.html">AKPsi Portal</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navMenu">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="members.html">Members</a></li>
        <li class="nav-item d-none" id="brotherPortalLink"><a class="nav-link" href="brother-portal.html">Brother Portal</a></li>
        <li class="nav-item d-none" id="adminPortalLink"><a class="nav-link" href="admin-portal.html">Admin Portal</a></li>
        <li class="nav-item d-none" id="mentionsLink"><a class="nav-link" href="mentions.html">Mentions</a></li>
        <li class="nav-item d-none" id="pnmDashboardLink"><a class="nav-link" href="pnm-dashboard.html">PNM Dashboard</a></li>
        <li class="nav-item d-none" id="rushDashboardLink"><a class="nav-link" href="rush-dashboard.html">Rush Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" id="greeting">Hi!</a></li>
        <li class="nav-item"><a class="btn btn-outline-light ms-2" href="signin.html" id="authButton">Sign In</a></li>
      </ul>
    </div>
  </div>
</nav>

<main class="container">
  <div class="dashboard-card">
    <h2 class="fw-bold mb-4 text-center">Interview Dashboard</h2>
    <p class="text-center text-muted">Submit and view interview feedback for PNMs.</p>

    <div class="table-responsive">
      <table class="table table-striped align-middle text-center">
        <thead>
          <tr>
            <th onclick="sortTable(0, false)">Name</th>
            <th onclick="sortTable(1, true)">Grad Year</th>
            <th onclick="sortTable(2, true)">Avg Accomplished</th>
            <th onclick="sortTable(3, true)">Avg Professionalism</th>
            <th onclick="sortTable(4, true)">Avg Interest</th>
            <th onclick="sortTable(5, true)">Avg Energy</th>
            <th onclick="sortTable(6, true)">Avg Friendliness</th>
            <th onclick="sortTable(7, true)">Positive Mentions</th>
            <th onclick="sortTable(8, true)">Negative Mentions</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="pnmTableBody"></tbody>
      </table>
    </div>
  </div>
</main>

<!-- Interview Modal -->
<div class="modal fade" id="interviewModal" tabindex="-1" aria-labelledby="interviewModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="interviewForm">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="interviewModalLabel">Submit Interview Feedback</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="interviewPnmId" />

        <div class="mb-3">
          <label class="form-label">Accomplished (1–5)</label>
          <select id="accomplished" class="form-select">
            <option value="">Select</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Professionalism (1–5)</label>
          <select id="professionalism" class="form-select">
            <option value="">Select</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Interest (1–5)</label>
          <select id="interest" class="form-select">
            <option value="">Select</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Energy (1–5)</label>
          <select id="energy" class="form-select">
            <option value="">Select</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Friendliness (1–5)</label>
          <select id="friendliness" class="form-select">
            <option value="">Select</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Comments</label>
          <textarea id="comments" class="form-control" rows="3" placeholder="Enter feedback..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary w-100">Submit Feedback</button>
      </div>
    </form>
  </div>
</div>

<!-- View Feedback Modal -->
<div class="modal fade" id="viewFeedbackModal" tabindex="-1" aria-labelledby="viewFeedbackModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="viewFeedbackModalLabel">Interview Feedback</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="feedbackContent"></div>
    </div>
  </div>
</div>

<script type="module">
  import { auth, db, listenAuth } from "./jsauth.js";
  import {
    collection, query, where, getDocs, addDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  listenAuth({
    greeting: document.getElementById("greeting"),
    authButton: document.getElementById("authButton"),
    brotherPortalLink: document.getElementById("brotherPortalLink"),
    adminPortalLink: document.getElementById("adminPortalLink"),
    mentionsLink: document.getElementById("mentionsLink"),
    pnmDashboardLink: document.getElementById("pnmDashboardLink"),
    rushDashboardLink: document.getElementById("rushDashboardLink"),
    interviewDashboardLink: null,
  });

  const pnmTableBody = document.getElementById("pnmTableBody");
  let currentUser = null;

  // ✅ Sorting logic
  let currentSortColumn = null;
  let currentSortDirection = "asc";

  function sortTable(columnIndex, isNumeric = true) {
    const table = document.querySelector("table");
    const tbody = table.querySelector("tbody");
    const rows = Array.from(tbody.querySelectorAll("tr"));

    if (currentSortColumn === columnIndex) {
      currentSortDirection = currentSortDirection === "asc" ? "desc" : "asc";
    } else {
      currentSortColumn = columnIndex;
      currentSortDirection = "asc";
    }

    rows.sort((a, b) => {
      const aText = a.children[columnIndex].textContent.trim();
      const bText = b.children[columnIndex].textContent.trim();
      const aVal = isNumeric ? parseFloat(aText) || 0 : aText.toLowerCase();
      const bVal = isNumeric ? parseFloat(bText) || 0 : bText.toLowerCase();
      return isNumeric
        ? currentSortDirection === "asc" ? aVal - bVal : bVal - aVal
        : currentSortDirection === "asc"
          ? aVal.localeCompare(bVal)
          : bVal.localeCompare(aVal);
    });

    tbody.innerHTML = "";
    rows.forEach((r) => tbody.appendChild(r));

    document.querySelectorAll("th").forEach((th) => (th.textContent = th.textContent.replace(" ▲", "").replace(" ▼", "")));
    const th = table.querySelectorAll("th")[columnIndex];
    th.textContent += currentSortDirection === "asc" ? " ▲" : " ▼";
  }

  // ✅ Expose globally for onclick to work
  window.sortTable = sortTable;

  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      window.location.href = "signin.html";
      return;
    }
    currentUser = user;
    loadPNMs();
  });

  function extractFive(d) {
    const q = d?.quantitative ? d.quantitative : d || {};
    return {
      accomplished: Number(q.accomplished) || 0,
      professionalism: Number(q.professionalism) || 0,
      interest: Number(q.interest) || 0,
      energy: Number(q.energy) || 0,
      friendliness: Number(q.friendliness) || 0,
    };
  }

  async function loadPNMs() {
    const pnmsSnap = await getDocs(query(collection(db, "users"), where("role", "==", "pnm")));
    pnmTableBody.innerHTML = "";

    for (const pnmDoc of pnmsSnap.docs) {
      const pnm = pnmDoc.data();
      const pnmId = pnmDoc.id;

      const interviewsSnap = await getDocs(query(collection(db, "interviews"), where("pnmId", "==", pnmId)));
      const mentionsSnap = await getDocs(query(collection(db, "mentions"), where("pnmId", "==", pnmId)));

      let total = { accomplished: 0, professionalism: 0, interest: 0, energy: 0, friendliness: 0 };
      let count = 0;

      interviewsSnap.forEach(docSnap => {
        const m = extractFive(docSnap.data());
        total.accomplished += m.accomplished;
        total.professionalism += m.professionalism;
        total.interest += m.interest;
        total.energy += m.energy;
        total.friendliness += m.friendliness;
        count++;
      });

      mentionsSnap.forEach(docSnap => {
        const m = extractFive(docSnap.data());
        const hasAny = m.accomplished || m.professionalism || m.interest || m.energy || m.friendliness;
        if (hasAny) {
          total.accomplished += m.accomplished;
          total.professionalism += m.professionalism;
          total.interest += m.interest;
          total.energy += m.energy;
          total.friendliness += m.friendliness;
          count++;
        }
      });

      const avg = count > 0 ? {
        accomplished: (total.accomplished / count).toFixed(1),
        professionalism: (total.professionalism / count).toFixed(1),
        interest: (total.interest / count).toFixed(1),
        energy: (total.energy / count).toFixed(1),
        friendliness: (total.friendliness / count).toFixed(1),
      } : { accomplished: "-", professionalism: "-", interest: "-", energy: "-", friendliness: "-" };

      const positiveMentionsCount = pnm.positiveMentions || 0;
      const negativeMentionsCount = pnm.negativeMentions || 0;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${pnm.firstName} ${pnm.lastName}</td>
        <td>${pnm.gradYear}</td>
        <td>${avg.accomplished}</td>
        <td>${avg.professionalism}</td>
        <td>${avg.interest}</td>
        <td>${avg.energy}</td>
        <td>${avg.friendliness}</td>
        <td>${positiveMentionsCount}</td>
        <td>${negativeMentionsCount}</td>
        <td>
          <button class="btn btn-sm btn-success me-1" onclick="openInterview('${pnmId}')">Add</button>
          <button class="btn btn-sm btn-secondary" onclick="viewFeedback('${pnmId}')">View</button>
        </td>`;
      pnmTableBody.appendChild(row);
    }
  }

  window.openInterview = (pnmId) => {
    document.getElementById("interviewPnmId").value = pnmId;
    new bootstrap.Modal(document.getElementById("interviewModal")).show();
  };

  document.getElementById("interviewForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const pnmId = document.getElementById("interviewPnmId").value;
    const accomplished = Number(document.getElementById("accomplished").value) || 0;
    const professionalism = Number(document.getElementById("professionalism").value) || 0;
    const interest = Number(document.getElementById("interest").value) || 0;
    const energy = Number(document.getElementById("energy").value) || 0;
    const friendliness = Number(document.getElementById("friendliness").value) || 0;
    const comments = document.getElementById("comments").value;

    await addDoc(collection(db, "interviews"), {
      pnmId,
      interviewerId: currentUser.uid,
      interviewerName: currentUser.email,
      quantitative: { accomplished, professionalism, interest, energy, friendliness },
      comments,
      timestamp: serverTimestamp()
    });

    alert("Interview submitted successfully!");
    document.getElementById("interviewForm").reset();
    bootstrap.Modal.getInstance(document.getElementById("interviewModal")).hide();
    loadPNMs();
  });

  window.viewFeedback = async (pnmId) => {
    const feedbackContent = document.getElementById("feedbackContent");
    feedbackContent.innerHTML = "";
    const snap = await getDocs(query(collection(db, "interviews"), where("pnmId", "==", pnmId)));
    if (snap.empty) {
      feedbackContent.innerHTML = "<p class='text-muted'>No interviews yet.</p>";
    } else {
      snap.forEach(doc => {
        const d = doc.data();
        const q = d.quantitative || d;
        feedbackContent.innerHTML += `
          <div class="border rounded p-3 mb-2">
            <strong>${d.interviewerName}</strong> (${new Date(d.timestamp.toDate()).toLocaleString()})<br />
            Accomplished: ${Number(q.accomplished)||0}, Professionalism: ${Number(q.professionalism)||0}, Interest: ${Number(q.interest)||0}, Energy: ${Number(q.energy)||0}, Friendliness: ${Number(q.friendliness)||0}<br />
            <em>${d.comments || ""}</em>
          </div>`;
      });
    }
    new bootstrap.Modal(document.getElementById("viewFeedbackModal")).show();
  };
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
