<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Profile | AKPsi Portal</title>

  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{ --akpsi-gold:#C9A227; }
    body{
      font-family:'Raleway',sans-serif;
      background:#f8f9fa;
    }
    .page-card{
      margin-top:120px;
      padding:2rem;
      background:#fff;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }
    .avatar{
      width:96px;height:96px;border-radius:50%;
      object-fit:cover;border:3px solid rgba(0,0,0,0.08);
      background:#e9ecef;
    }
    .muted{ color:rgba(0,0,0,0.6); }
    .progress{ height:10px; border-radius:999px; }
    .progress-bar{ background:var(--akpsi-gold); }
  </style>
</head>

<body>

  <!-- Navbar (simple + consistent) -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm fixed-top">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">AKPsi Portal</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navMenu">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link active" href="edit-profile.html">Edit Profile</a></li>
          <li class="nav-item"><a class="nav-link" id="greeting">Hi!</a></li>
          <li class="nav-item">
            <a class="btn btn-outline-light ms-2" href="signin.html" id="authButton">Sign In</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container">
    <div class="page-card">
      <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
        <div>
          <h2 class="fw-bold mb-1">Edit Profile</h2>
          <div class="muted" id="subtitle">Update your name and profile photo.</div>
        </div>
      </div>

      <hr class="my-4">

      <div class="row g-4 align-items-start">
        <!-- Avatar -->
        <div class="col-12 col-md-4">
          <div class="d-flex align-items-center gap-3">
            <img id="avatarPreview" class="avatar" alt="Profile photo">
            <div>
              <div class="fw-bold" id="namePreview">—</div>
              <div class="muted" id="emailPreview">—</div>
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label fw-bold">Change photo</label>
            <input type="file" class="form-control" id="photoInput" accept="image/*">
            <div class="muted mt-2" style="font-size:.95rem;">
              <i class="bi bi-info-circle"></i> Recommended: square image, under 2MB.
            </div>

            <div class="mt-3 d-none" id="uploadProgressWrap">
              <div class="muted mb-1" id="uploadLabel">Uploading…</div>
              <div class="progress">
                <div class="progress-bar" id="uploadProgressBar" style="width:0%"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Form -->
        <div class="col-12 col-md-8">
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label fw-bold">First Name</label>
              <input class="form-control" id="firstNameInput" placeholder="First name">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label fw-bold">Last Name (optional)</label>
              <input class="form-control" id="lastNameInput" placeholder="Last name">
            </div>

            <div class="col-12">
              <button class="btn btn-dark" id="saveBtn">
                <i class="bi bi-save"></i> Save Changes
              </button>
              <span class="ms-3 muted" id="statusText"></span>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <script type="module">
    import { auth, db } from "./jsauth.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    import {
      getStorage,
      ref,
      uploadBytesResumable,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

    const storage = getStorage();

    // Navbar
    const greeting = document.getElementById("greeting");
    const authButton = document.getElementById("authButton");

    // UI
    const subtitle = document.getElementById("subtitle");
    const statusText = document.getElementById("statusText");

    const avatarPreview = document.getElementById("avatarPreview");
    const namePreview = document.getElementById("namePreview");
    const emailPreview = document.getElementById("emailPreview");

    const firstNameInput = document.getElementById("firstNameInput");
    const lastNameInput = document.getElementById("lastNameInput");
    const photoInput = document.getElementById("photoInput");
    const saveBtn = document.getElementById("saveBtn");

    const uploadProgressWrap = document.getElementById("uploadProgressWrap");
    const uploadProgressBar = document.getElementById("uploadProgressBar");
    const uploadLabel = document.getElementById("uploadLabel");

    let currentUser = null;
    let currentUserData = null;
    let pendingPhotoFile = null;

    function setStatus(msg, isError=false){
      statusText.textContent = msg || "";
      statusText.style.color = isError ? "#b00020" : "rgba(0,0,0,0.6)";
    }

    function safeName(data, fallbackEmail){
      const first = (data?.firstName || "").trim();
      const last = (data?.lastName || "").trim();
      const combined = `${first} ${last}`.trim();
      return combined || (fallbackEmail ? fallbackEmail.split("@")[0] : "—");
    }

    function showUploadProgress(pct){
      uploadProgressWrap.classList.remove("d-none");
      uploadProgressBar.style.width = `${pct}%`;
      uploadLabel.textContent = `Uploading… ${Math.round(pct)}%`;
      if (pct >= 100) uploadLabel.textContent = "Finalizing…";
    }

    async function uploadProfilePhoto(uid, file){
      const fileName = `${Date.now()}_${file.name}`;
      const photoRef = ref(storage, `profile_photos/${uid}/${fileName}`);
      const uploadTask = uploadBytesResumable(photoRef, file);

      return new Promise((resolve, reject) => {
        uploadTask.on("state_changed",
          (snap) => {
            const pct = (snap.bytesTransferred / snap.totalBytes) * 100;
            showUploadProgress(pct);
          },
          reject,
          async () => {
            const url = await getDownloadURL(uploadTask.snapshot.ref);
            resolve(url);
          }
        );
      });
    }

    async function loadProfile(user){
      const userRef = doc(db, "users", user.uid);
      const snap = await getDoc(userRef);
      if (!snap.exists()){
        subtitle.textContent = "Profile document not found in Firestore.";
        return;
      }
      currentUserData = snap.data();

      emailPreview.textContent = user.email;
      const displayName = safeName(currentUserData, user.email);
      namePreview.textContent = displayName;

      firstNameInput.value = currentUserData.firstName || "";
      lastNameInput.value = currentUserData.lastName || "";

      const url = currentUserData.photoURL || "";
      avatarPreview.src = url || "https://via.placeholder.com/96?text=AKPsi";
    }

    photoInput.addEventListener("change", () => {
      const file = photoInput.files && photoInput.files[0] ? photoInput.files[0] : null;
      pendingPhotoFile = file;

      if (file){
        const tempUrl = URL.createObjectURL(file);
        avatarPreview.src = tempUrl;
        setStatus("Photo ready to upload. Click Save Changes.");
      } else {
        setStatus("");
      }
    });

    saveBtn.addEventListener("click", async () => {
      if (!currentUser) return;

      saveBtn.disabled = true;
      setStatus("Saving…");

      try {
        const firstName = firstNameInput.value.trim();
        const lastName = lastNameInput.value.trim();

        if (!firstName){
          setStatus("First name is required.", true);
          saveBtn.disabled = false;
          return;
        }

        const updates = { firstName, lastName };

        // Upload photo if selected
        if (pendingPhotoFile){
          const url = await uploadProfilePhoto(currentUser.uid, pendingPhotoFile);
          updates.photoURL = url;
        }

        await updateDoc(doc(db, "users", currentUser.uid), updates);

        uploadProgressWrap.classList.add("d-none");
        pendingPhotoFile = null;
        photoInput.value = "";

        setStatus("Saved!");
        namePreview.textContent = `${firstName} ${lastName}`.trim();
      } catch (err) {
        console.error(err);
        setStatus("Failed to save changes.", true);
      } finally {
        saveBtn.disabled = false;
      }
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user){
        window.location.href = "signin.html";
        return;
      }
      currentUser = user;

      // Greeting + logout
      greeting.textContent = `Hi!`;
      authButton.textContent = "Log Out";
      authButton.href = "#";
      authButton.onclick = async (e) => {
        e.preventDefault();
        await signOut(auth);
        window.location.href = "signin.html";
      };

      await loadProfile(user);

      const firstName = currentUserData?.firstName || user.email.split("@")[0];
      greeting.textContent = `Hi, ${firstName}!`;
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
